<% provide(:title, "My収支情報ページ") %>
<div class="sidebar-fixed container-scroller" style="background-color: rgb(44, 44, 44);">
  <%= render 'shared/sidebar' %>
  <div class="container-fluid page-body-wrapper">
    <!-- partial:partials/_navbar.html -->
    <%= render 'shared/topbar' %>
    <!-- partial -->
    <div class="main-panel">
      <div class="content-wrapper">
        <%= render 'shared/ad' %>
        <%= render 'shared/flash' %>

        <div class="row">
          <div class="col-md-12 grid-margin stretch-card">
            <div class="card">
              <div class="card-body" style="color: white;">
                <h4 class="card-title">イベント収支情報</h4>
                <% values = { total_payment: @total_payment, total_overdue_debt: @total_overdue_debt,
                              total_non_overdue_debt: @total_non_overdue_debt, urgent_transactions: @urgent_transactions } %>
                <%= render 'shared/balance_chart', values %>
              </div>
            </div>
          </div>
          <div class="col-md-12 grid-margin stretch-card">
            <div class="card">
              <div class="card-body" style="color: black;">
                <h4 class="card-title">イベント収支履歴</h4>
                <div class="row">
                  <div class="col-12">
                    <div class="table-responsive">
                      <table id="order-listing" class="table">
                        <thead>
                          <tr>
                            <th>イベント名</th>
                            <th>支払い期限</th>
                            <th>金額</th>
                            <th>支払った金額</th>
                            <th>支払い相手</th>
                            <th>支払い状況</th>
                            <th>領収書発行</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% @transactions.each do |transaction| %>
                            <% deadline = transaction.deadline %>
                            <% debt = transaction.debt %>
                            <% payment = transaction.payment %>
                            <tr>
                              <td>
                                <% if event = transaction.event %>
                                  <%= link_to event.name.truncate(20), details_group_event_path(group_id: event.group_id, id: event.id) %>
                                <% else %>
                                  <%= transaction.creditor.name %>
                                <% end %>
                              </td>
                              <td><%= l deadline, format: :short %></td>
                              <td>￥<%= transaction.debt %></td>
                              <td>￥<%= transaction.payment %></td>
                              <td><%= transaction.creditor.name %></td>
                              <% if debt == payment %>
                                <td>
                                  <label class="badge badge-success">完了</label>
                                </td>
                                <td>
                                  <%= link_to "発行", receipt_transaction_path(url_token: transaction.url_token, format: "pdf"), class: "btn btn-outline-primary" %>
                                </td>
                              <% elsif debt > payment %>
                                <td>
                                  <% if deadline > @today %>
                                    <label class="badge badge-primary">予定</label>
                                  <% else %>
                                    <label class="badge badge-danger">未払い</label>
                                  <% end %>
                                </td>
                                <td></td>
                              <% else %>
                                <td>
                                  <label class="badge badge-info">過払い</label>
                                </td>
                                <td></td>
                              <% end %>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                      <%= paginate @transactions %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-12 grid-margin stretch-card">
            <div class="card">
              <div class="card-body" style="color: black;">
                <h4 class="card-title">個人間収支履歴</h4>
                <div class="row">
                  <div class="col-12">
                    <div class="table-responsive">
                      <table id="order-listing" class="table">
                        <thead>
                          <tr>
                            <th>貸し借り</th>
                            <th>期限</th>
                            <th>金額</th>
                            <th>支払った金額</th>
                            <th>支払い相手</th>
                            <th>支払い状況</th>
                            <th>変更</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% @individual_transactions.each do |transaction| %>
                            <% deadline = transaction.deadline %>
                            <% debt = transaction.debt %>
                            <% payment = transaction.payment %>
                            <% url_token = transaction.url_token %>
                            <tr>
                              <td>
                                <% is_lending = transaction.lending?(user: current_user) %>
                                <% if is_lending %>
                                  <label class="btn btn-outline-primary">貸した</label>
                                <% else %>
                                  <label class="btn btn-outline-danger">借りた</label>
                                <% end %>
                              </td>
                              <td><%= l deadline, format: :short %></td>
                              <td>￥<%= transaction.debt %></td>
                              <td>￥<%= transaction.payment %></td>
                              <td>
                                <% if is_lending %>
                                  <%= transaction.debtor.name %>
                                <% else %>
                                  <%= transaction.creditor.name %>
                                <% end %>
                              </td>
                              <% if debt == payment %>
                                <td>
                                  <label class="badge badge-success">完了</label>
                                </td>
                              <% elsif debt > payment %>
                                <td>
                                  <% if deadline > @today %>
                                    <label class="badge badge-primary">予定</label>
                                  <% else %>
                                    <label class="badge badge-danger">未完了</label>
                                  <% end %>
                                </td>
                              <% else %>
                                <td>
                                  <label class="badge badge-info">過払い</label>
                                </td>
                              <% end %>
                              <td><%= link_to '変更する', edit_users_transaction_path(url_token: url_token), class: "btn btn-outline-primary" %></td>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                      <%= paginate @individual_transactions %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- content-wrapper ends -->
      <!-- partial:partials/_footer.html -->
      <footer class="footer">
        <div class="d-sm-flex justify-content-center justify-content-sm-between">
          <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2019 <a href="https://www.bootstrapdash.com/" target="_blank">BootstrapDash</a>. All rights reserved.</span>
          <span class="text-muted float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Hand-crafted & made with <i class="mdi mdi-heart text-danger"></i></span>
        </div>
      </footer>
      <!-- partial -->
    </div>
    <!-- main-panel ends -->
  </div>
  <!-- page-body-wrapper ends -->
</div>

